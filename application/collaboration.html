<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Collaboration Page</title>
    <!-- Stylesheet -->
    <link rel="stylesheet" href="css/general_style.css">
    <link rel="stylesheet" href="css/site_styles.css"> 

    <link rel="stylesheet" href="style.css">
    <script type="module" src="pdfjs/build/pdf.mjs"></script>

    <link rel="stylesheet" href="./css/comments.css">
    <link rel="stylesheet" href="./css/site_styles.css">
    <style>
        #pdf-section {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #viewer-container {
            width: 100%;
            height: calc(100vh - 100px);
            margin-top: 50px;
            position: relative;
            z-index: 1; /* Lower z-index for the viewer */
        }
        #comment-box {
            position: fixed;
            right: 20px;
            top: 60px;
            width: 200px;
            display: none;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1001;
        }
        #comment-display {
            position: fixed;
            right: 20px;
            top: 100px;
            width: 200px;
            display: none;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            padding: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1001;
        }
        .comment-marker {
            position: absolute;
            border-radius: 50%;
            width: 12px;
            height: 12px;
            cursor: pointer;
            text-align: center;
            line-height: 12px;
            z-index: 9999; /* Set to a high value to ensure markers are on top */
        }

        #navigation-buttons {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        #buttons {
            display: none;
        }
    </style>
</head>
<body>
    <header id="main-header"></header>
    <div class="grid-row">
        <div class="col-mid-9">
            <div id="pdf-section">
                <div id="navigation-buttons">
                    <button id="prev-page" class="">Previous Page</button>
                    <span id="page-info">Page: 1</span>
                    <button id="next-page" class="">Next Page</button>
                </div>
                <button id="toggle-comment">Add Comment</button>
                <div id="buttons">
                    <button id="undo">Undo</button>
                    <button id="redo">Redo</button>
                </div>
            </div>
            <div id="viewer-container"></div>
        </div>
        <div class="col-mid-3">
            <!-- Content Area -->
            <section class="content" id="content-area">
                <button class="add-question-btn" id="add-question-btn">Add Question</button>
                <div id="question-buttons"></div> <!-- This is where dynamic question buttons will appear -->
            </section>
    
            <!-- Interaction Area -->
            <section class="interaction-area" id="interaction-area">
                <!-- Bubbles Above Interaction Area -->
                <div class="bubble-container">
                    <div class="bubble" data-category="all">
                        <div class="category-block block-gray"></div>All
                    </div>
                    <div class="bubble" data-category="urgent">
                        <div class="category-block block-red"></div>Urgent
                    </div>
                    <div class="bubble" data-category="regular">
                        <div class="category-block block-green"></div>Regular
                    </div>
                    <div class="bubble" data-category="followup">
                        <div class="category-block block-blue"></div>Follow Up
                    </div>
                </div>
    
                <div id="questions-list">
                    <!-- Questions will be dynamically added here -->
                </div>
            </section>
    
            <!-- Pop-up for Add/Edit Question -->
            <div class="popup" id="add-edit-question-popup">
                <div class="popup-header">
                    <h3 id="popup-title">New Question</h3>
                    <button class="close-btn" id="close-popup-btn">&times;</button>
                </div>
                <div class="popup-body">
                    <label for="category">Select Category:</label>
                    <div class="category-bubble-container" id="category-bubble-container">
                        <div class="category-bubble" data-category="urgent">
                            <div class="category-block block-red"></div>Urgent
                        </div>
                        <div class="category-bubble" data-category="regular">
                            <div class="category-block block-green"></div>Regular
                        </div>
                        <div class="category-bubble" data-category="followup">
                            <div class="category-block block-blue"></div>Follow Up
                        </div>
                    </div>
    
                    <!-- Message Textarea -->
                    <label for="message">Message</label>
                    <textarea id="message" rows="4" placeholder="Write your question here..."></textarea>
    
                    <!-- File Upload -->
                    <label for="file-upload" class="file-upload">Upload File:</label>
                    <input type="file" id="file-upload">
    
                    <!-- Pop-up Footer -->
                    <div class="popup-footer">
                        <button class="cancel-btn" id="cancel-btn">Cancel</button>
                        <button class="submit-btn" id="submit-question-btn">Submit</button>
                    </div>
                </div>
            </div>
    
            <!-- Pop-up for Reply -->
            <div class="popup" id="reply-popup">
                <div class="popup-header">
                    <h3>Reply to Question</h3>
                    <button class="close-btn" id="close-reply-popup">&times;</button>
                </div>
    
                <div class="popup-body">
                    <!-- Reply Message Textarea -->
                    <label for="reply-message">Reply Message</label>
                    <textarea id="reply-message" rows="4" placeholder="Write your reply here..."></textarea>
    
                    <!-- File Upload -->
                    <label for="reply-file-upload" class="file-upload">Upload File:</label>
                    <input type="file" id="reply-file-upload">
    
                    <!-- Pop-up Footer -->
                    <div class="popup-footer">
                        <button class="cancel-btn" id="cancel-reply-btn">Cancel</button>
                        <button class="submit-btn" id="submit-reply-btn">Submit</button>
                    </div>
                </div>
            </div>
        
        </div>
    </div>



    <div id="comment-box">
        <textarea id="comment-input" placeholder="Type your comment here..."></textarea>
        <br>
        <button id="save-comment">Save</button>
        <button id="cancel-comment">Cancel</button>
    </div>
    <div id="comment-display"></div>


    <script src="./js/header.js"></script>
    <script src="./js/comments.js"></script>

    <script type="module">
        import { getDocument, GlobalWorkerOptions } from './pdfjs/build/pdf.mjs';

        GlobalWorkerOptions.workerSrc = './pdfjs/build/pdf.worker.mjs';

        let viewerElement; // Declare viewerElement globally
        const commentBox = document.getElementById('comment-box');
        const commentInput = document.getElementById('comment-input');
        const toggleCommentButton = document.getElementById('toggle-comment');
        const buttonsContainer = document.getElementById('buttons');
        const pageInfo = document.getElementById('page-info');
        const commentDisplay = document.getElementById('comment-display');
        const prevPageButton = document.getElementById('prev-page');
        const nextPageButton = document.getElementById('next-page');

        let drawingMode = false;
        let currentDrawing = [];
        let pdfDoc = null;
        let currentPage = 1;
        const pagesData = {}; // Store all drawings and comments for each page
        let commentIdCounter = 1; // Counter for unique comment IDs

        // Load the PDF document
        const url = 'media/files/assignment_1.pdf';
        getDocument(url).promise.then(pdf => {
            pdfDoc = pdf;
            renderPage(currentPage);
        });

        async function renderPage(pageNumber) {
            if (!viewerElement) {
                viewerElement = document.getElementById('viewer-container'); // Initialize if not set
            }

            // Clear previous page content but keep viewerElement
            viewerElement.innerHTML = '';

            // Create and set up a new canvas
            const canvas = document.createElement('canvas');
            const page = await pdfDoc.getPage(pageNumber);
            const viewport = page.getViewport({ scale: 1 });
            canvas.width = viewport.width;
            canvas.height = viewport.height;

            // Append the new canvas to the viewer
            viewerElement.appendChild(canvas);

            // Get the drawing context
            const context = canvas.getContext('2d');

            // Render the PDF page onto the canvas
            await page.render({ canvasContext: context, viewport: viewport }).promise;

            // Retrieve and render drawings and markers for the current page
            if (pagesData[pageNumber]) {
                pagesData[pageNumber].drawings.forEach(drawing => {
                    drawLine(drawing.points);
                });
                pagesData[pageNumber].markers.forEach(marker => {
                    createCommentMarker(marker.id, marker.position, marker.color);
                });
            }

            // Add event listeners for drawing on the newly created canvas
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mousemove', draw);

            updatePageInfo();
        }


        function updatePageInfo() {
            pageInfo.textContent = `Page: ${currentPage}`;
        }

        function startDrawing(event) {
            if (drawingMode) {
                currentDrawing = [{ x: event.offsetX, y: event.offsetY }];
                const context = viewerElement.lastChild.getContext('2d');
                context.beginPath();
                context.moveTo(event.offsetX, event.offsetY);
            }
        }

        function stopDrawing(event) {
            if (drawingMode && currentDrawing.length > 0) {
                currentDrawing.push({ x: event.offsetX, y: event.offsetY });
                drawLine(currentDrawing);

                // Save the drawing for the current page
                const commentId = `#${commentIdCounter}`;
                saveDrawing(commentId, currentDrawing);

                currentDrawing = []; // Reset drawing state
            }
        }

        function draw(event) {
            if (drawingMode && currentDrawing.length > 0) {
                const context = viewerElement.lastChild.getContext('2d');
                context.lineTo(event.offsetX, event.offsetY);
                context.stroke();
            }
        }

        function drawLine(points) {
            if (points.length < 2) return;

            const context = viewerElement.lastChild.getContext('2d');
            context.beginPath();
            context.moveTo(points[0].x, points[0].y);
            for (const point of points) {
                context.lineTo(point.x, point.y);
            }
            context.stroke();
        }

        function createCommentMarker(commentId, position, color = 'yellow') {
            const marker = document.createElement('div');
            marker.className = 'comment-marker';
            marker.style.left = `${(viewerElement.clientWidth / 2) - 6}px`; // Center horizontally
            marker.style.top = `${(viewerElement.clientHeight / 2) - 6}px`; // Center vertically
            marker.style.backgroundColor = color; // Set color

            marker.onclick = () => toggleCommentDisplay(commentId); // Toggle comment display on click

            if (!pagesData[currentPage]) {
                pagesData[currentPage] = { drawings: [], comments: [], markers: [] }; // Initialize if undefined
            }
            pagesData[currentPage].markers.push({ id: commentId, position: { y: viewerElement.clientHeight / 2 }, color });

            viewerElement.appendChild(marker); // Append marker to the viewer
        }

        let isCommentVisible = false; // Track the visibility of the comment

        function toggleCommentDisplay(commentId) {
            const comment = pagesData[currentPage].comments.find(c => c.id === commentId);
            
            if (isCommentVisible && commentDisplay.innerText.includes(commentId)) {
                // If the comment is already visible and clicked again, hide it
                commentDisplay.style.display = 'none';
                isCommentVisible = false; // Update the visibility state
            } else {
                // Show the comment if it's not already visible
                if (comment) {
                    commentDisplay.innerText = `${commentId}: ${comment.text}`; // Set comment text with ID
                    commentDisplay.style.display = 'block'; // Show comment box
                    isCommentVisible = true; // Update the visibility state
                }
            }
        }

        function saveDrawing(commentId, points) {
            if (!pagesData[currentPage]) {
                pagesData[currentPage] = { drawings: [], comments: [], markers: [] };
            }
            pagesData[currentPage].drawings.push({ commentId, points });
        }

        function displayAllMarkers() {
            const allMarkers = pagesData[currentPage].markers;
            console.log("All Markers on Page " + currentPage + ":");
            allMarkers.forEach(marker => {
                console.log(`ID: ${marker.id}, Position: ${marker.position.y}, Color: ${marker.color}`);
            });
        }

        function saveComment(commentId, text, position) {
            if (!pagesData[currentPage]) {
                pagesData[currentPage] = { drawings: [], comments: [], markers: [] };
            }
            pagesData[currentPage].comments.push({ id: commentId, text, position });
            const averageY = (position.y + 20) / 2; // Average Y for marker placement
            pagesData[currentPage].markers.push({ id: commentId, position: { y: averageY }, color: 'yellow' });
            createCommentMarker(commentId, { y: averageY }); // Create marker immediately after saving the comment
            displayAllMarkers(); // Print all markers after saving a new comment
        }

        toggleCommentButton.addEventListener('click', () => {
            drawingMode = !drawingMode;
            commentBox.style.display = drawingMode ? 'block' : 'none';
            buttonsContainer.style.display = drawingMode ? 'block' : 'none';
            toggleCommentButton.textContent = drawingMode ? 'Exit Comment Mode' : 'Add Comment';
        });

        // Update the event listener for saving comments
        document.getElementById('save-comment').addEventListener('click', () => {
            const commentText = commentInput.value.trim();
            if (commentText) {
                const commentId = `#${commentIdCounter++}`; // Generate unique comment ID
                const commentPosition = { x: viewerElement.clientWidth - 30, y: 20 }; // Fixed x, dynamic y

                saveComment(commentId, commentText, commentPosition);
                commentInput.value = ''; // Clear the input
                commentBox.style.display = 'none'; // Hide comment box

                // Reset states after saving
                drawingMode = false;
                toggleCommentButton.textContent = 'Add Comment';
                buttonsContainer.style.display = 'none'; // Hide the button container
                isCommentVisible = false; // Reset visibility
                commentDisplay.style.display = 'none'; // Hide comment display
            }
        });

        document.getElementById('cancel-comment').addEventListener('click', () => {
            commentInput.value = ''; // Clear the input
            commentBox.style.display = 'none'; // Hide comment box
        });

        prevPageButton.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderPage(currentPage);
            }
        });

        nextPageButton.addEventListener('click', () => {
            if (currentPage < pdfDoc.numPages) {
                currentPage++;
                renderPage(currentPage);
            }
        });

    </script>

</body>
</html>
